<script>

	var lineChartEsp32TemperatureValues = [];

	/**
	 * On success handler
	 * Creates a line chart in case server executes
	 * getSensorValues() successfully
	 */
	function onSuccess(ar) {
		// just for debug purposes
		//console.log(ar);

		var lineChartLabels = [];
		var lineChartTemperatureValues = [];
		var lineChartHumidityValues = [];
		var lineChartBatteryVoltageValues = [];
		var chartColors = ['#059e8a', '#00add6', '#e69500'];

		var catchFirstElement = false;

		var max = 0.0;
		var min = 0.0;
		var sum = 0.0;

		//let shouldSkip = false;
		ar.forEach(function (item, index) {
			/*
			The code caused a problem when the temperature was set to 0.0
				  if (shouldSkip) {
					  return;
				  }
				  if ((item[0] == "") || (item[1] == "")) {
					  shouldSkip = true;
			  console.log("skipped");
					  return;
				  }
			*/
			if (catchFirstElement == false) {
				startMeasurementsDate = new Date(item[0] * 1000);
				catchFirstElement = true;
			}
			var myDate = formattedDateTime(new Date(item[0] * 1000));
			lineChartLabels.push(myDate); // or lineChartLabels.push(myDate.toGMTString());
			lineChartTemperatureValues.push((+item[1]).toFixed(1));
			lineChartHumidityValues.push((+item[2]).toFixed(1));
			lineChartBatteryVoltageValues.push((+item[3]).toFixed(3));

			var deltaTemperature = ((+item[4]).toFixed(1) - (+item[1]).toFixed(1)).toFixed(1);
			lineChartEsp32TemperatureValues.push(deltaTemperature);
			var fDeltaTemperature = parseFloat(deltaTemperature);
			if (fDeltaTemperature > max) {
				max = fDeltaTemperature;
			}
			if (fDeltaTemperature < min) {
				min = fDeltaTemperature;
			}
			sum = sum + fDeltaTemperature;
		});

		let avg = sum / lineChartEsp32TemperatureValues.length;

		// just for debug purposes
		//console.log("lineChartTemperatureValues= " + lineChartTemperatureValues)

		// the line chart data
		var lineChartTemperatureData = {
			labels: lineChartLabels,
			datasets: [{
				label: 'Temperature',
				data: lineChartTemperatureValues,
				fill: false,
				borderColor: chartColors[0],
				tension: 0.1,
				showLine: false,
			}],
		};

		var chartOptions = {
			plugins: {
				legend: {
					display: false
				},
				zoom: {
					zoom: {
						wheel: {
							enabled: true,
						},
						pinch: {
							enabled: true
						},
						mode: 'x',
					}
				},
				/*, // not needed here anymore, toFixed() done directly on JSON response
				tooltip: {
				  callbacks: {
					label: function(context) {
					  // this guarantees that 1 decimal place is shown -> e.g. '22.0'
					  return context.parsed.y.toFixed(1);
					}
				  }
				}
				*/
			},
			scales: {
				x: {
					ticks: {
						display: true
					},
					display: false
				},
				y: {
					beginAtZero: false,
					display: true,
				}
			}
		};

		// grab the line chart context
		var ctx = document.getElementById("lineChartTemperature").getContext("2d");

		// render/show/create the line chart to be shown now
		var lineChartTemperature = new Chart(ctx, {
			type: 'line',
			data: lineChartTemperatureData,
			options: chartOptions,
		});

		// the line chart data
		var lineChartHumidityData = {
			labels: lineChartLabels,
			datasets: [{
				label: 'Humidity',
				data: lineChartHumidityValues,
				fill: false,
				borderColor: chartColors[1],
				tension: 0.1,
				showLine: false,
			}],
		};

		// grab the line chart context
		ctx = document.getElementById("lineChartHumidity").getContext("2d");

		// render/show/create the line chart to be shown now
		var lineChartHumidity = new Chart(ctx, {
			type: 'line',
			data: lineChartHumidityData,
			options: chartOptions,
		});

		// the line chart data
		var lineChartBatteryVoltageData = {
			labels: lineChartLabels,
			datasets: [{
				label: 'Battery Voltage',
				data: lineChartBatteryVoltageValues,
				fill: false,
				borderColor: chartColors[2],
				tension: 0.1,
				showLine: false,
			}],
		};

		// grab the line chart context
		ctx = document.getElementById("lineChartBatteryVoltage").getContext("2d");

		var chartOptionsBattVoltage = {
			plugins: {
				legend: {
					display: false
				},
				zoom: {
					zoom: {
						wheel: {
							enabled: true,
						},
						pinch: {
							enabled: true
						},
						mode: 'x',
					}
				}
			},
			scales: {
				x: {
					ticks: {
						display: true
					},
					display: false
				},
				y: {
					display: true,
					max: 4.30,
					min: 2.90
				}
			}
		};

		// render/show/create the line chart to be shown now
		var lineChartBatteryVoltage = new Chart(ctx, {
			type: 'line',
			data: lineChartBatteryVoltageData,
			options: chartOptionsBattVoltage
		});

		// the line chart data
		var lineChartEsp32TemperatureData = {
			labels: lineChartLabels,
			datasets: [{
				label: 'Temperature',
				data: lineChartEsp32TemperatureValues,
				fill: false,
				borderColor: chartColors[0],
				tension: 0.1,
				showLine: false,
			}],
		};

		// grab the line chart context
		ctx = document.getElementById("lineChartEsp32Temperature").getContext("2d");

		// render/show/create the line chart to be shown now
		var lineChartEsp32Temperature = new Chart(ctx, {
			type: 'line',
			data: lineChartEsp32TemperatureData,
			options: chartOptions,
		});

		var nrOfSamples = lineChartLabels.length;
		document.getElementById("info").innerText = "Total of " + nrOfSamples + " measurements during the period " + lineChartLabels[0] + " - " + lineChartLabels[nrOfSamples - 1];

		document.getElementById("temperature").innerText = lineChartTemperatureValues[lineChartTemperatureValues.length - 1];
		document.getElementById("humidity").innerText = lineChartHumidityValues[lineChartHumidityValues.length - 1];
		document.getElementById("batteryVoltage").innerText = lineChartBatteryVoltageValues[lineChartBatteryVoltageValues.length - 1];
		document.getElementById("esp32Temperature").innerText = lineChartEsp32TemperatureValues[lineChartEsp32TemperatureValues.length - 1];

		//var arr = maxMinAvg(lineChartEsp32TemperatureValues);
		document.getElementById("esp32Temperature-avg").innerText = parseFloat(avg).toFixed(1);
		document.getElementById("esp32Temperature-max").innerText = parseFloat(max).toFixed(1);
		document.getElementById("esp32Temperature-min").innerText = parseFloat(min).toFixed(1);

		const dateStartMeas = document.querySelectorAll('.date-start-measurement');
		dateStartMeas.forEach(elem => {
			elem.innerHTML = "since " + formattedDate(new Date(lineChartLabels[0]));
		});

		const dateLastMeas = document.querySelectorAll(".date-last-measurement");
		dateLastMeas.forEach(elem => {
			elem.innerHTML = lineChartLabels[lineChartLabels.length - 1];
		});

		// clear user feedback
		document.getElementById("feedback").innerText = "";
		document.getElementById("loader").style.display = "none";
		document.getElementById("temperature-info").style.display = "block";
		document.getElementById("temperature-stats").style.display = "block";
		document.getElementById("humidity-info").style.display = "block";
		document.getElementById("humidity-stats").style.display = "block";
		document.getElementById("batteryVoltage-info").style.display = "block";
		document.getElementById("batteryVoltage-stats").style.display = "block";
		document.getElementById("esp32Temperature-info").style.display = "block";
		document.getElementById("esp32Temperature-stats").style.display = "block";
		document.getElementById("esp32WorkTime-info").style.display = "block";
		document.getElementById("esp32WorkTime-stats").style.display = "block";
		document.getElementById("next").style.visibility = "visible";
	};

	/**
	* Formatted date & time (yyyy-mm-dd, hh:mm)
	*/
	function formattedDateTime(localDate) {
		const yyyy = localDate.getFullYear();
		let mm = localDate.getMonth() + 1; // Months start at 0!
		let dd = localDate.getDate();
		if (dd < 10) dd = '0' + dd;
		if (mm < 10) mm = '0' + mm;
		const hours = localDate.getHours();
		let minutes = localDate.getMinutes();
		if (minutes < 10) minutes = '0' + minutes;

		return yyyy + '-' + mm + '-' + dd + ', ' + hours + ':' + minutes;
	}

	/**
	* Formatted date (yyyy-mm-dd)
	*/
	function formattedDate(localDate) {
		const yyyy = localDate.getFullYear();
		let mm = localDate.getMonth() + 1; // Months start at 0!
		let dd = localDate.getDate();
		if (dd < 10) dd = '0' + dd;
		if (mm < 10) mm = '0' + mm;

		return yyyy + '-' + mm + '-' + dd;
	}

	/**
	 * Converts milliseconds to (D day(s), HH:MM:SS.s) format
	 */
	function msToTime(millis) {
		var milliseconds = Math.floor((millis % 1000) / 100),
			seconds = Math.floor((millis / 1000) % 60),
			minutes = Math.floor((millis / (1000 * 60)) % 60),
			hours = Math.floor((millis / (1000 * 60 * 60)) % 24),
			days = Math.floor(millis / (1000 * 60 * 60 * 24));

		hours = (hours < 10) ? "0" + hours : hours;
		minutes = (minutes < 10) ? "0" + minutes : minutes;
		seconds = (seconds < 10) ? "0" + seconds : seconds;

		let hourMinSecs = hours + ":" + minutes + ":" + seconds + "." + milliseconds;

		if (days == 0) {
			return hourMinSecs;
		}

		if (days == 1) {
			return days + " day, " + hourMinSecs;
		}

		return days + " days, " + hourMinSecs;
	}

	function maxMinAvg(arr) {
		//console.log(arr[0]);
		var max = parseFloat(arr[0]);
		var min = parseFloat(arr[0]);
		var sum = parseFloat(arr[0]);
		for (var i = 1; i < arr.length; i++) {
			let value = parseFloat(arr[i])
			if (value > max) {
				max = value;
			}
			if (value < min) {
				min = value;
			}
			sum = sum + value;
		}
		console.log(max); console.log(min); console.log(sum);
		return [max, min, sum / arr.length];
	}

	/**
	 * Execute on server failure
	 */
	function onFailure() {
		document.getElementById('feedback').innerText = "Server not responding, please try later again.";
		document.getElementById("loader").style.display = "none";
		localStorage.setItem("visited", "false");
	}

	/**
	 * On success handler
	 * Show statistic values in case server executes
	 * getStatistics() successfully
	 */
	function onSuccessStatistics(ar) {
		// just for debug purposes
		console.log(ar);

		//let shouldSkip = false;
		ar.forEach(function (item, index) {
			/*
			The code caused a problem when the temperature was set to 0.0
				  if (shouldSkip) {
					  return;
				  }
				  if ((item[0] == "") || (item[1] == "") || (item[2] == "") ||
					  (item[3] == "") || (item[4] == "") || (item[5] == "")) {
			  console.log("skipped!");
					  shouldSkip = true;
					  return;
				  }
			*/
			document.getElementById("temperature-avg").innerText = parseFloat(item[0]).toFixed(1);
			document.getElementById("temperature-max").innerText = parseFloat(item[1]).toFixed(1);
			document.getElementById("temperature-min").innerText = parseFloat(item[2]).toFixed(1);
			document.getElementById("humidity-avg").innerText = parseFloat(item[3]).toFixed(1);
			document.getElementById("humidity-max").innerText = parseFloat(item[4]).toFixed(1);
			document.getElementById("humidity-min").innerText = parseFloat(item[5]).toFixed(1);
			document.getElementById("batteryVoltage-avg").innerText = parseFloat(item[6]).toFixed(3);
			document.getElementById("batteryVoltage-max").innerText = parseFloat(item[7]).toFixed(3);
			document.getElementById("batteryVoltage-min").innerText = parseFloat(item[8]).toFixed(3);

			document.getElementById("esp32WorkTime").innerText = msToTime(parseInt(item[12]));
			document.getElementById("esp32SleepTime").innerText = msToTime(parseInt(item[16]) * 1000);
			document.getElementById("esp32WorkTime-avg").innerText = (item[13] - item[0]).toFixed(1);
			document.getElementById("esp32WorkTime-max").innerText = (item[14] - item[1]).toFixed(1);
			document.getElementById("esp32WorkTime-min").innerText = (item[15] - item[2]).toFixed(1);
		});
	}

</script>